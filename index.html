<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reabilita√ß√£o Inteligente | Dr. Jo√£o Paulo</title>
    
    <!-- Tailwind CSS (Estilo) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- √çcones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; padding-bottom: 150px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-section { display: none; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="bg-white/90 backdrop-blur-xl border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-2xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="renderPhase(0)">
                <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center shadow-lg relative border border-slate-100">
                    <span class="text-white font-black italic text-sm">JP</span>
                </div>
                <div>
                    <span class="block text-[9px] font-black tracking-widest text-slate-400 uppercase">Fisioterapia</span>
                    <span class="block text-xs font-black tracking-tighter text-slate-800 leading-none">REABILITA√á√ÉO INTELIGENTE</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Progresso</p>
                    <p id="global-progress" class="text-xs font-black text-blue-600">0%</p>
                </div>
                <!-- C√≠rculo de Progresso Simples -->
                <div class="w-8 h-8 rounded-full border-4 border-slate-100 flex items-center justify-center relative">
                    <div id="progress-indicator" class="absolute inset-0 rounded-full border-4 border-blue-600 border-t-transparent animate-spin" style="animation-duration: 0s;"></div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-6 py-6">
        <!-- Navega√ß√£o -->
        <nav class="flex gap-2 p-1 bg-slate-200 rounded-2xl mb-8 overflow-x-auto no-scrollbar sticky top-20 z-30">
            <button onclick="renderPhase(0)" id="btn-0" class="flex-1 py-3 px-4 rounded-xl text-[10px] font-black transition-all bg-blue-600 text-white shadow-md">IN√çCIO</button>
            <button onclick="renderPhase(1)" id="btn-1" class="flex-1 py-3 px-4 rounded-xl text-[10px] font-black transition-all text-slate-500 hover:bg-white/50">FASE 1</button>
            <button onclick="renderPhase(2)" id="btn-2" class="flex-1 py-3 px-4 rounded-xl text-[10px] font-black transition-all text-slate-500 hover:bg-white/50">FASE 2</button>
            <button onclick="renderPhase(3)" id="btn-3" class="flex-1 py-3 px-4 rounded-xl text-[10px] font-black transition-all text-slate-500 hover:bg-white/50">FASE 3</button>
        </nav>

        <!-- Container Principal -->
        <div id="app-content" class="fade-in">
            <!-- Conte√∫do ser√° injetado aqui via JavaScript -->
        </div>
    </main>

    <!-- Barra Inferior -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t border-slate-200 p-4 z-50 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <div class="max-w-2xl mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-3 shrink-0 cursor-pointer hover:scale-105 transition-transform" onclick="toggleChat()">
                <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center relative">
                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                    <span class="absolute top-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></span>
                </div>
                <div class="hidden sm:block">
                    <p class="text-[10px] font-black text-slate-400 leading-none mb-0.5">D√öVIDAS?</p>
                    <p class="text-xs font-bold text-slate-700">Assistente IA</p>
                </div>
            </div>
            
            <a href="https://wa.me/5521972183072" target="_blank" class="flex-1 bg-slate-900 text-white px-4 py-3 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-between hover:bg-slate-800">
                <div class="flex flex-col">
                    <span class="text-[8px] uppercase tracking-widest text-slate-400">Acelere sua recupera√ß√£o</span>
                    <span class="text-[11px] font-black flex items-center gap-2">CONSULTORIA PREMIUM</span>
                </div>
                <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
                    <i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400"></i>
                </div>
            </a>
        </div>
    </nav>

    <!-- Modal Chat IA -->
    <div id="chat-modal" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center pointer-events-none p-4 bg-black/20 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md h-[500px] max-h-[80vh] rounded-2xl shadow-2xl border border-slate-200 flex flex-col pointer-events-auto transform transition-transform duration-300 translate-y-10 scale-95">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-blue-600 rounded-t-2xl text-white">
                <div class="flex items-center gap-2">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                    <h3 class="font-bold text-sm">Suporte Inteligente</h3>
                </div>
                <button onclick="toggleChat()"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                <!-- Mensagens -->
                <div class="flex justify-start">
                    <div class="max-w-[85%] p-3 rounded-2xl text-xs leading-relaxed bg-white text-slate-700 shadow-sm border border-slate-200 rounded-bl-none">
                        Ol√°! Sou a IA do Dr. Jo√£o Paulo. Tem alguma d√∫vida sobre os exerc√≠cios ou sua dor?
                    </div>
                </div>
            </div>
            <form onsubmit="sendMessage(event)" class="p-3 bg-white border-t border-slate-100 rounded-b-2xl flex gap-2">
                <input id="chat-input" type="text" placeholder="Digite sua d√∫vida..." class="flex-1 bg-slate-100 rounded-xl px-4 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="bg-blue-600 text-white p-3 rounded-xl"><i data-lucide="send" class="w-4 h-4"></i></button>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT (L√ìGICA DO APP) -->
    <script>
        // --- DADOS E CONTE√öDO ---
        const PORTAL_DATA = {
            0: {
                title: "üëã Bem-vindo √† sua Recupera√ß√£o",
                intro: "Voc√™ n√£o est√° sozinho. Este portal cont√©m o m√©todo exato para te levar da cirurgia at√© voltar a andar com seguran√ßa.",
                instructions: "Toque na fase correspondente abaixo para liberar seus exerc√≠cios di√°rios.",
                videoSource: "/videos/boas_vindas.mp4",
                phases_summary: [
                    { id: 1, icon: "üõ°Ô∏è", title: "Fase 1: Prote√ß√£o", sub: "Semana 0-4 ‚Ä¢ Controle e Repouso" },
                    { id: 2, icon: "üë£", title: "Fase 2: Mobilidade", sub: "Liberado p√© no ch√£o (Carga Parcial)" },
                    { id: 3, icon: "üí™", title: "Fase 3: For√ßa Total", sub: "Liberado peso total (Largar Muletas)" }
                ],
                disclaimer: {
                    title: "Termos de Uso e Responsabilidade",
                    text: "Este aplicativo serve como guia de suporte e orienta√ß√£o domiciliar. Ele N√ÉO substitui o julgamento cl√≠nico do seu m√©dico ou fisioterapeuta presencial.",
                    crefito: "Respons√°vel T√©cnico: Dr. Jo√£o Paulo Cardozo"
                }
            },
            1: {
                title: "FASE 1: üõ°Ô∏è Prote√ß√£o",
                subtitle: "Semanas 0 a 4",
                intro: "Foco absoluto em desinchar e proteger a cirurgia. O objetivo √© manter o sangue circulando sem for√ßar o tornozelo.",
                driveLink: "https://drive.google.com/file/d/1N7-q2EIOh5bYqCLatPmHZFw73GjCUK-E/view?usp=drivesdk",
                introVideoSource: "/videos/fase1_intro.mp4",
                warning: {
                    title: "üö® Sinais de Alerta (Triagem)",
                    intro: "O desconforto no local da cirurgia √© esperado. Por√©m, fique atento a estes sinais que N√ÉO s√£o normais:",
                    items: [
                        { label: "Risco de Trombose", text: "Dor aguda isolada na panturrilha, incha√ßo repentino e rigidez." },
                        { label: "Sinais de Infec√ß√£o", text: "Secre√ß√£o (pus), vermelhid√£o ou febre." },
                        { label: "Circula√ß√£o", text: "Dedos muito p√°lidos ou frios." }
                    ],
                    footer: "Procure seu m√©dico se notar algo."
                },
                regraOuro: "Regra de Ouro: O desconforto leve √© normal, mas 'pontadas' agudas na cirurgia n√£o.",
                achievements: [ "Ferida seca e limpa", "Dormir sem dor intensa", "Incha√ßo diminui pela manh√£", "Mover dedos livremente" ],
                sections: [
                    { name: "Protocolo Di√°rio", desc: "üßä Gelo: 20min a cada 4h.\nü¶µ Eleva√ß√£o: Perna acima do cora√ß√£o.\nü¶∂ Movimento: Mexer dedos sempre.", dosage: "Todo dia" },
                    { name: "1. Bombeamento Isom√©trico", desc: "Fa√ßa for√ßa na batata da perna como se quisesse pisar no acelerador, mas SEM deixar o p√© mexer.", dosage: "3x 10 reps", videoSource: "/videos/fase1_ex1.mp4" },
                    { name: "2. O 'Pianista'", desc: "Tente abrir bem os dedos dos p√©s e depois fechar com for√ßa.", dosage: "3x 15 reps", videoSource: "/videos/fase1_ex2.mp4" },
                    { name: "3. Ativa√ß√£o de Gl√∫teo", desc: "Deitado, aperte uma n√°dega contra a outra com for√ßa.", dosage: "3x 15 reps", videoSource: "/videos/fase1_ex3.mp4" },
                    { name: "4. Eleva√ß√£o de Perna", desc: "Deitado, trave o joelho e levante a perna esticada.", dosage: "3x 10 reps", videoSource: "/videos/fase1_ex4.mp4" },
                    { name: "5. P√© no Ch√£o", desc: "Sentado, apoie o p√© no ch√£o sem peso. Se ficar vermelho √© normal.", dosage: "2 -> 15 min", videoSource: "/videos/fase1_ex5.mp4" }
                ]
            },
            2: {
                title: "FASE 2: üë£ Mobilidade",
                subtitle: "Carga Parcial Liberada",
                intro: "Vamos recuperar o movimento de 90¬∫ do tornozelo e ensinar seu p√© a receber peso novamente.",
                driveLink: "https://drive.google.com/file/d/1aECf1_hLa0Xfyr_RHAvSQXT_GInZ7TqL/view?usp=drivesdk",
                introVideoSource: "/videos/fase2_intro.mp4",
                warning: { type: "info", title: "‚ö†Ô∏è Requisito de Seguran√ßa", text: "S√≥ fa√ßa se o m√©dico liberou Carga Parcial (pisar com aux√≠lio)." },
                achievements: [ "P√© atinge 90 graus", "Piso com carga parcial sem dor", "Uso t√™nis confort√°vel", "Iniciei desmame muletas" ],
                sections: [
                    { name: "1. Alongamento Toalha", desc: "Puxe a ponta do p√© com uma toalha at√© sentir 'repuxar'.", dosage: "3x 30s", videoSource: "/videos/fase2_ex1.mp4" },
                    { name: "2. O Acelerador (Livre)", desc: "Leve o p√© o m√°ximo para cima e para baixo.", dosage: "3x 15 reps", videoSource: "/videos/fase2_ex2.mp4" },
                    { name: "3. O Acelerador (El√°stico)", desc: "Empurre para baixo contra o el√°stico e segure a volta.", dosage: "3x 15 reps", videoSource: "/videos/fase2_ex3.mp4" },
                    { name: "4. A Balan√ßa", desc: "Em p√© com muletas, transfira levemente o peso para o p√© operado.", dosage: "3x 1 min", videoSource: "/videos/fase2_ex4.mp4" }
                ]
            },
            3: {
                title: "FASE 3: üí™ For√ßa Total",
                subtitle: "Retorno √† Vida Normal",
                intro: "Foco em fortalecer a panturrilha e treinar o equil√≠brio. Prepara√ß√£o para alta.",
                driveLink: "https://drive.google.com/file/d/1s96n1p49pQJZC0OXRtFfHr0oVYTG4op2/view?usp=drivesdk",
                introVideoSource: "/videos/fase3_intro.mp4",
                warning: { type: "stop", title: "‚õî Requisito Obrigat√≥rio", text: "Exige libera√ß√£o m√©dica para CARGA TOTAL (pisar sem muletas)." },
                achievements: [ "Degraus sem apoio", "Fico na ponta dos p√©s", "Equil√≠brio num p√© s√≥", "Caminho sem mancar" ],
                sections: [
                    { name: "1. Joelho na Parede", desc: "Toque o joelho na parede sem tirar o calcanhar do ch√£o.", dosage: "3x 12 reps", videoSource: "/videos/fase3_ex1.mp4" },
                    { name: "2. Eleva√ß√£o Calcanhar", desc: "Suba na ponta dos p√©s (Bipodal -> Unipodal).", dosage: "3x 15 reps", videoSource: "/videos/fase3_ex2.mp4" },
                    { name: "3. Mini-Agachamento", desc: "Dobre levemente os joelhos. N√£o tire calcanhares.", dosage: "3x 10 reps", videoSource: "/videos/fase3_ex3.mp4" },
                    { name: "4. O Gar√ßa", desc: "Equilibre-se na perna operada. Solte a m√£o aos poucos.", dosage: "3x 30s", videoSource: "/videos/fase3_ex4.mp4" },
                    { name: "5. Obst√°culo", desc: "Passe a perna boa por cima de um objeto equilibrando.", dosage: "3x 10v", videoSource: "/videos/fase3_ex5.mp4" }
                ]
            }
        };

        // --- ESTADO GLOBAL ---
        let userState = JSON.parse(localStorage.getItem('jp_portal_state')) || {};
        let activePhase = 0;

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
        function renderPhase(id) {
            activePhase = id;
            updateNav(id);
            const container = document.getElementById('app-content');
            const data = PORTAL_DATA[id];
            
            // Remove anima√ß√£o antiga para reiniciar
            container.classList.remove('fade-in');
            void container.offsetWidth; // trigger reflow
            container.classList.add('fade-in');

            if (id === 0) {
                // TELA INICIAL
                let phasesHtml = data.phases_summary.map(p => `
                    <div onclick="renderPhase(${p.id})" class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm cursor-pointer hover:border-blue-300 hover:shadow-lg transition-all flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center text-xl shadow-sm">${p.icon}</div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg">${p.title}</h3>
                            <p class="text-xs text-slate-500 font-medium">${p.sub}</p>
                        </div>
                        <i data-lucide="chevron-right" class="ml-auto text-blue-200"></i>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="space-y-6">
                        <div id="motivation-card" class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden">
                             <div class="flex items-center gap-2 mb-2 opacity-80"><i data-lucide="sparkles" class="w-4 h-4"></i><span class="text-[10px] font-black uppercase tracking-widest">Dose Di√°ria</span></div>
                             <p id="mot-text" class="text-sm font-medium mb-4 opacity-90">Precisa de um empurr√£ozinho hoje?</p>
                             <button onclick="getMotivation()" class="bg-white/20 px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> Receber Mensagem</button>
                        </div>

                        <div class="bg-white rounded-[2rem] p-8 shadow-xl border border-slate-100 relative overflow-hidden">
                            <h2 class="text-3xl font-black mb-4 leading-tight text-slate-800">${data.title}</h2>
                            <p class="text-slate-500 text-sm mb-6 font-medium">${data.intro}</p>
                            
                            <div class="mb-6 rounded-2xl overflow-hidden shadow-lg bg-black aspect-video relative">
                                ${getVideoHTML(data.videoSource)}
                            </div>

                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <p class="text-[10px] font-black uppercase text-blue-400 mb-1">Instru√ß√µes:</p>
                                <p class="text-xs text-blue-900 font-bold">${data.instructions}</p>
                            </div>
                        </div>

                        <div>${phasesHtml}</div>

                        <div class="mt-8 p-6 bg-slate-100 rounded-3xl border border-slate-200 text-center">
                            <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest mb-2">${data.disclaimer.title}</h4>
                            <p class="text-[11px] text-slate-500 leading-relaxed mb-4 max-w-md mx-auto">${data.disclaimer.text}</p>
                            <div class="inline-flex items-center gap-2 px-4 py-2 bg-white rounded-full border border-slate-200 shadow-sm">
                                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                <p class="text-[10px] font-bold text-slate-700 uppercase">${data.disclaimer.crefito}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // TELAS DE FASE
                let warningHtml = '';
                if(data.warning) {
                    if(data.warning.items) {
                        warningHtml = `<div class="mt-6 bg-red-50 border-l-4 border-red-400 rounded-r-2xl p-5 shadow-sm">
                            <div class="flex items-center gap-2 mb-3"><span class="text-xl">üö®</span><h4 class="text-xs font-black text-red-800 uppercase">${data.warning.title}</h4></div>
                            <p class="text-xs text-red-700 mb-4 opacity-80">${data.warning.intro}</p>
                            <div class="space-y-3">${data.warning.items.map(i => `<div class="bg-white/60 p-3 rounded-xl border border-red-100"><p class="text-xs font-bold text-red-900 mb-1">${i.label}</p><p class="text-[11px] text-red-700">${i.text}</p></div>`).join('')}</div>
                        </div>`;
                    } else {
                        let color = data.warning.type === 'stop' ? 'red' : 'amber';
                        warningHtml = `<div class="mt-4 p-4 bg-${color}-50 border-l-4 border-${color}-500 rounded-r-xl shadow-sm flex gap-3 items-center">
                            <div class="text-2xl">${data.warning.type === 'stop' ? '‚õî' : '‚ö†Ô∏è'}</div>
                            <div><p class="text-xs font-bold text-${color}-800 uppercase">${data.warning.title}</p><p class="text-xs text-${color}-700 mt-1">${data.warning.text}</p></div>
                        </div>`;
                    }
                }

                let checkListHtml = data.achievements.map((ach, idx) => {
                    let key = `f${id}_c${idx}`;
                    let checked = userState[key] ? 'checked' : '';
                    let style = userState[key] ? 'text-slate-400 line-through' : 'text-slate-700';
                    return `
                    <div onclick="toggleAch('${key}')" class="flex items-start gap-3 p-3 rounded-xl cursor-pointer hover:bg-slate-50 border-l-2 border-transparent hover:border-blue-500">
                        <div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${userState[key] ? 'bg-blue-600 border-blue-600' : 'border-slate-300'}">
                            ${userState[key] ? '<i data-lucide="check" class="text-white w-3 h-3"></i>' : ''}
                        </div>
                        <label class="text-xs font-bold select-none ${style}">${ach}</label>
                    </div>`;
                }).join('');

                let exercisesHtml = data.sections.map((ex, idx) => `
                    <div class="bg-white rounded-3xl overflow-hidden border border-slate-100 shadow-sm p-6 mb-4">
                        <div class="flex justify-between items-start mb-3 gap-4">
                            <div class="flex gap-3"><span class="text-slate-300 font-black text-sm">0${idx+1}</span><h4 class="font-black text-slate-800 text-sm italic">${ex.name}</h4></div>
                            <span class="text-[9px] font-black bg-slate-100 text-slate-600 px-2 py-1 rounded-lg uppercase whitespace-nowrap shrink-0">${ex.dosage}</span>
                        </div>
                        <p class="text-slate-500 text-xs leading-relaxed mb-4 pl-7 border-l-2 border-slate-100 whitespace-pre-line">${ex.desc}</p>
                        
                        <div id="vid-${idx}" class="hidden mb-4 bg-black rounded-xl overflow-hidden aspect-video">
                            ${getVideoHTML(ex.videoSource)}
                        </div>

                        <button onclick="toggleVideo('vid-${idx}')" class="w-full flex items-center justify-center gap-2 bg-slate-900 text-white py-3 rounded-xl text-[10px] font-black uppercase tracking-wider hover:bg-blue-600 transition-colors">
                            <i data-lucide="play" class="w-3 h-3"></i> Ver Execu√ß√£o
                        </button>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="mb-8">
                        <span class="inline-block px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[10px] font-bold uppercase mb-2 tracking-wider shadow-sm">${data.subtitle}</span>
                        <h2 class="text-3xl font-black text-slate-900 leading-tight mb-3">${data.title}</h2>
                        <p class="text-slate-600 text-sm leading-relaxed font-medium mb-6">${data.intro}</p>
                        
                        ${data.driveLink ? `<a href="${data.driveLink}" target="_blank" class="flex items-center justify-center gap-3 w-full bg-slate-900 text-white py-4 rounded-2xl shadow-xl active:scale-95 transition-all mb-6"><i data-lucide="external-link" class="w-4 h-4"></i><span class="font-black text-xs uppercase tracking-widest">Assistir Aula (Drive)</span></a>` : ''}

                        ${data.regraOuro ? `<div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-xl shadow-sm"><p class="text-xs text-blue-900 font-bold">üíé ${data.regraOuro}</p></div>` : ''}
                        
                        ${warningHtml}
                    </div>

                    <div class="mb-10 bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-4 pb-4 border-b border-slate-50">
                           <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Checklist</h3>
                           <span class="text-[10px] font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-full" id="phase-counter">0/0</span>
                        </div>
                        <div class="space-y-3">${checkListHtml}</div>
                    </div>

                    <div class="space-y-6">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-2 mb-4">Exerc√≠cios</h3>
                        ${exercisesHtml}
                    </div>
                `;
            }
            lucide.createIcons();
            updateProgress();
        }

        // --- AUXILIARES ---
        function updateNav(id) {
            [0,1,2,3].forEach(i => {
                let btn = document.getElementById(`btn-${i}`);
                if(i === id) {
                    btn.className = "flex-1 py-3 px-4 rounded-xl text-[10px] font-black transition-all bg-blue-600 text-white shadow-md scale-105";
                } else {
                    btn.className = "flex-1 py-3 px-4 rounded-xl text-[10px] font-black transition-all text-slate-500 hover:bg-white/50";
                }
            });
        }

        function toggleAch(key) {
            userState[key] = !userState[key];
            localStorage.setItem('jp_portal_state', JSON.stringify(userState));
            renderPhase(activePhase); // Re-render para atualizar visual
        }

        function updateProgress() {
            let total = 0, done = 0;
            // Conta conquistas das fases 1, 2, 3
            Object.keys(PORTAL_DATA).forEach(k => {
                if(k != 0 && PORTAL_DATA[k].achievements) {
                    PORTAL_DATA[k].achievements.forEach((_, i) => {
                        total++;
                        if(userState[`f${k}_c${i}`]) done++;
                    });
                }
            });
            let perc = total === 0 ? 0 : Math.round((done/total)*100);
            
            // Atualiza Header
            document.getElementById('global-progress').innerText = perc + "%";
            // O indicador visual circular simplificado
            document.getElementById('progress-indicator').style.display = perc > 0 ? 'block' : 'none';
        }

        function toggleVideo(id) {
            let el = document.getElementById(id);
            el.classList.toggle('hidden');
        }

        function getVideoHTML(source) {
            if(!source || source.includes('VIDEO_ID')) {
                return `<div class="w-full h-full flex flex-col items-center justify-center text-slate-500"><i data-lucide="video" class="w-8 h-8 mb-2 opacity-50"></i><span class="text-[10px] font-bold uppercase">V√≠deo Demonstrativo</span></div>`;
            }
            if(source.includes('.mp4')) {
                return `<video src="${source}" controls class="w-full h-full object-cover"></video>`;
            }
            // Youtube fallback (se usar IDs no futuro)
            return `<iframe class="w-full h-full" src="https://www.youtube.com/embed/${source}" frameborder="0" allowfullscreen></iframe>`;
        }

        // --- IA E CHAT ---
        function toggleChat() {
            let modal = document.getElementById('chat-modal');
            let content = modal.querySelector('div');
            
            if(modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('translate-y-10', 'scale-95');
                }, 10);
            } else {
                modal.classList.add('opacity-0');
                content.classList.add('translate-y-10', 'scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        async function sendMessage(e) {
            e.preventDefault();
            let input = document.getElementById('chat-input');
            let text = input.value;
            if(!text.trim()) return;

            let chatBox = document.getElementById('chat-messages');
            
            // Msg Usuario
            chatBox.innerHTML += `<div class="flex justify-end"><div class="max-w-[85%] p-3 rounded-2xl text-xs leading-relaxed bg-blue-600 text-white rounded-br-none">${text}</div></div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // Loading
            let loadingId = 'load-' + Date.now();
            chatBox.innerHTML += `<div id="${loadingId}" class="flex justify-start"><div class="p-3"><i data-lucide="loader-2" class="animate-spin text-blue-500 w-4 h-4"></i></div></div>`;

            // Chama API (Simula√ß√£o segura se n√£o tiver chave)
            // Para funcionar real, precisaria de um backend ou expor a chave (n√£o recomendado em HTML puro p√∫blico, mas para teste serve)
            // Aqui vamos dar uma resposta padr√£o se n√£o tiver backend configurado
            
            setTimeout(async () => {
                document.getElementById(loadingId).remove();
                let reply = await callGemini(text);
                chatBox.innerHTML += `<div class="flex justify-start"><div class="max-w-[85%] p-3 rounded-2xl text-xs leading-relaxed bg-white text-slate-700 shadow-sm border border-slate-200 rounded-bl-none">${reply}</div></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 1000);
        }

        async function getMotivation() {
            let btn = document.querySelector('#motivation-card button');
            let txt = document.getElementById('mot-text');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-3 h-3"></i> Carregando...`;
            
            let msg = await callGemini("Frase motivacional curta para recupera√ß√£o tornozelo com emoji");
            txt.innerText = `"${msg}"`;
            txt.classList.add('font-bold', 'text-lg');
            
            btn.disabled = false;
            btn.innerHTML = `<i data-lucide="rotate-ccw" class="w-3 h-3"></i> Nova Mensagem`;
        }

        // Fun√ß√£o "Mock" da IA para HTML est√°tico (Para funcionar real precisa da Key)
        // Se voc√™ tiver a KEY, substitua a string vazia abaixo.
        const API_KEY = ""; 

        async function callGemini(prompt) {
            if(!API_KEY) return "O Chat Inteligente precisa de configura√ß√£o. (Adicione a API Key no c√≥digo HTML)";
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                return "Erro de conex√£o. Tente novamente.";
            }
        }

        // INICIALIZA√á√ÉO
        window.onload = () => {
            renderPhase(0);
        };
    </script>
</body>
</html>

